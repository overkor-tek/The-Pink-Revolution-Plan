name: Pink Revolution CI

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]

jobs:
  audit:
    name: Audit Pink Compliance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install colorama

      - name: Run Pink Revolution Audit
        run: |
          if [ -f "tools/pink_revolution.py" ]; then
            python tools/pink_revolution.py scan .
            python tools/pink_revolution.py report .
          else
            echo "âš ï¸ Pink Revolution scanner not found. Skipping audit."
          fi

      - name: Check for blue colors
        id: blue_check
        run: |
          # Search for common blue color codes
          BLUES_FOUND=0

          # Check for hex blues
          if grep -r --include="*.css" --include="*.scss" --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" --include="*.html" -E "#(0{0,2}7[0-9a-fA-F]{1}[bB][fF]{2}|21[0-9]{2}[eE][fF]3|00[0-9]{2}[bB]{2})" .; then
            BLUES_FOUND=1
          fi

          echo "blues_found=$BLUES_FOUND" >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.blue_check.outputs.blues_found == '1'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âš ï¸ **Blue colors detected!** Please transform all blues to pink. ğŸ’–\n\nSee the [Pink Revolution Playbook](../playbooks/transformation-playbook.md) for guidance.'
            })

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          if [ -f "package.json" ]; then
            npm ci
          fi

      - name: Run tests
        run: |
          if [ -f "package.json" ]; then
            npm test
          else
            echo "No Node.js tests found"
          fi

      - name: Check test coverage
        run: |
          if [ -f "package.json" ] && grep -q "coverage" package.json; then
            npm run coverage
          fi

  visual-regression:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: |
          if [ -f "package.json" ]; then
            npm ci
          fi

      - name: Run visual regression tests
        run: |
          if grep -q "visual-regression" package.json 2>/dev/null; then
            npm run visual-regression
          else
            echo "No visual regression tests configured"
          fi

  accessibility:
    name: Accessibility Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'

      - name: Install Pa11y
        run: npm install -g pa11y-ci

      - name: Run accessibility audit
        run: |
          if [ -f ".pa11yci.json" ]; then
            pa11y-ci
          else
            echo "No Pa11y config found. Skipping accessibility audit."
          fi

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run npm audit
        run: |
          if [ -f "package.json" ]; then
            npm audit --audit-level=moderate || true
          fi

      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test

  build:
    name: Build Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: |
          if [ -f "package.json" ]; then
            npm ci
          fi

      - name: Build project
        run: |
          if grep -q "build" package.json 2>/dev/null; then
            npm run build
          else
            echo "No build script found"
          fi

      - name: Check bundle size
        run: |
          if [ -d "dist" ] || [ -d "build" ]; then
            du -sh dist/ build/ 2>/dev/null || echo "No build output to measure"
          fi

  pink-celebration:
    name: Pink Revolution Success! ğŸ‰
    runs-on: ubuntu-latest
    needs: [audit, test, accessibility, build]
    if: success()

    steps:
      - name: Celebrate
        run: |
          echo "ğŸ’–ğŸ’–ğŸ’–ğŸ’–ğŸ’–ğŸ’–ğŸ’–ğŸ’–ğŸ’–ğŸ’–ğŸ’–ğŸ’–ğŸ’–ğŸ’–ğŸ’–ğŸ’–"
          echo "ğŸ’–                            ğŸ’–"
          echo "ğŸ’–  All checks passing!       ğŸ’–"
          echo "ğŸ’–  Pink Revolution approved! ğŸ’–"
          echo "ğŸ’–                            ğŸ’–"
          echo "ğŸ’–ğŸ’–ğŸ’–ğŸ’–ğŸ’–ğŸ’–ğŸ’–ğŸ’–ğŸ’–ğŸ’–ğŸ’–ğŸ’–ğŸ’–ğŸ’–ğŸ’–ğŸ’–"
