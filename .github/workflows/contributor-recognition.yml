name: Contributor Recognition

on:
  pull_request_target:
    types: [closed]

jobs:
  recognize:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if first contribution
        uses: actions/github-script@v6
        id: check-first
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              per_page: 100
            });

            const userPRs = prs.filter(pr =>
              pr.user.login === context.payload.pull_request.user.login &&
              pr.merged_at
            );

            const isFirst = userPRs.length === 1;
            return isFirst;

      - name: Celebrate first merged PR
        if: steps.check-first.outputs.result == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const username = context.payload.pull_request.user.login;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `## ðŸŽ‰ CONGRATULATIONS @${username}! ðŸŽ‰

Your first PR has been merged! ðŸš€

### ðŸ† Achievement Unlocked: First Contribution!

You're now officially a Pink Revolution contributor! ðŸ’–

**What this means:**
- âœ… You're in the contributors list
- âœ… You've earned the "First Contribution" badge
- âœ… You're part of the Pink Revolution history
- âœ… You're making a real impact!

**What's next?**
- ðŸŒŸ Check out [WEEKLY_CHALLENGES.md](../WEEKLY_CHALLENGES.md) for more tasks
- ðŸ“ˆ Level up with [LEARNING_PATH.md](../docs/LEARNING_PATH.md)
- ðŸ¤ Help other contributors
- ðŸ’¬ Share your experience on social media (#PinkRevolution)

**Your Stats:**
- ðŸŽ¯ PRs Merged: 1
- ðŸ… Current Level: â­ Contributor
- ðŸŽ–ï¸ Badges: First Contribution

**Next Milestone:**
- 5 merged PRs â†’ â­â­ Regular Contributor

Thank you for being part of the revolution! ðŸ’–

---

*Want to be featured? Share your contribution story in Discussions!*`
            });

            // Add label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: ['ðŸŽ‰ first-contribution']
            });

      - name: Check for milestone contributions
        uses: actions/github-script@v6
        with:
          script: |
            const username = context.payload.pull_request.user.login;

            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              per_page: 100
            });

            const userMergedPRs = prs.filter(pr =>
              pr.user.login === username && pr.merged_at
            ).length;

            const milestones = {
              5: 'â­â­ Regular Contributor',
              10: 'â­â­â­ Dedicated Contributor',
              20: 'â­â­â­â­ Core Contributor',
              50: 'â­â­â­â­â­ Pink Revolution Champion'
            };

            if (milestones[userMergedPRs]) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `## ðŸŒŸ MILESTONE ACHIEVEMENT! ðŸŒŸ

@${username} has reached **${userMergedPRs} merged PRs!**

### ðŸ† ${milestones[userMergedPRs]} Unlocked!

This is a HUGE accomplishment! ðŸŽ‰

Your dedication to The Pink Revolution is inspiring. Thank you for your continued contributions! ðŸ’–

**Your Impact:**
- ðŸ’ª ${userMergedPRs} merged pull requests
- ðŸŒ Helping transform the world pink
- ðŸ‘¥ Inspiring others to contribute
- ðŸš€ Driving the revolution forward

**Special Recognition:**
You've been added to the [Pink Champions](../CONTRIBUTORS.md) list! ðŸ…

Keep up the amazing work! ðŸ’–

---

*Share your journey! We'd love to feature your story.*`
              });

              // Add champion label if 50+ PRs
              if (userMergedPRs >= 50) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  labels: ['ðŸ’– pink-champion']
                });
              }
            }
